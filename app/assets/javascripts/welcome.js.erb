  var map, infoWindow;
  var markers = [];
  var savedmarkers= [];
  var firstmarker= true;
  var topic= '<%=image_url('0.png')%>';
  function initMap() {

    infoWindow = new google.maps.InfoWindow;

      // HTML5 geolocation.
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
        var pos = {
          lat: position.coords.latitude,
          lng: position.coords.longitude
        };

        infoWindow.setPosition(pos);
        infoWindow.setContent('Location found.');
        infoWindow.open(map);
        map.setCenter(pos);
      }, function() {
        handleLocationError(true, infoWindow, map.getCenter());
      });
    } else {
      // Browser doesn't support Geolocation
      handleLocationError(false, infoWindow, map.getCenter());
    }
    map = new google.maps.Map(document.getElementById('map'), {
      zoom: 4,
      center: {lat: -34.397, lng: 150.644},
    });
    load_user_targets();
    // This event listener calls addMarker() when the map is clicked.
    google.maps.event.addListener(map, 'click', function(event) {
      $.getJSON('/targets/load_create_target', function(data) {
        $(".rectangle").html(data.form);
        $('#latitude').val(event.latLng.lat());
        $('#longitude').val(event.latLng.lng());
        $(".topic").click(function() {
        $('#topic_id').val( $(this).data('topicId'));
        });
      });
      if (!firstmarker){
        markers[0].setMap(null);
        markers.pop();
      }
      firstmarker= false;
      topic= '<%=image_url('0.png')%>';
      addMarker(event.latLng, map,topic);
    });
  }

  function handleLocationError(browserHasGeolocation, infoWindow, pos) {
    infoWindow.setPosition(pos);
    infoWindow.setContent(browserHasGeolocation ?
                          'Error: The Geolocation service failed.' :
                          'Error: Your browser doesn\'t support geolocation.');
    infoWindow.open(map);
  }

  // Adds a marker to the map.
  function addMarker(location, map, topic) {
    var marker = new google.maps.Marker({
      position: location,
      map: map,
      icon: topic,
      draggable:true
    });
    if (topic == '<%=image_url('0.png')%>'){
      markers.push(marker);
    }else{
      savedmarkers.push(marker);
    }
    map.panTo(location);
  }

  function addCircles(radius,localtopic){
    markers[0].setMap(null);
    var center= markers[0].getPosition();
    topic= localtopic;
    addMarker(center, map,topic);

    var cityCircle = new google.maps.Circle({
      strokeColor: '#FDBD39',
      strokeOpacity: 0.8,
      strokeWeight: 2,
      fillColor: '#FFCB03',
      fillOpacity: 0.35,
      map: map,
      center: center,
      radius: radius
    });

  }
  function load_user_targets() {
  $.getJSON('/targets/list', function(targetsList) {
    jQuery.each(targetsList, function(index, target){

      var latitude= parseFloat(target.latitud);
      var longitude= parseFloat(target.longitud);
      var location = {lat: latitude, lng: longitude};
      var marker = new google.maps.Marker({
        position: location,
        map: map,
        icon: "/assets/"+target.topic_id+".png",
        draggable:true
      });
      var cityCircle = new google.maps.Circle({
        strokeColor: '#FDBD39',
        strokeOpacity: 0.8,
        strokeWeight: 2,
        fillColor: '#FFCB03',
        fillOpacity: 0.35,
        map: map,
        center: location,
        radius: target.area
      });
    });
  });
}
